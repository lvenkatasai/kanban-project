<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Board</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@dnd-kit/core@6.0.8/dist/index.umd.js"></script>
    <script src="https://unpkg.com/@dnd-kit/sortable@7.0.2/dist/index.umd.js"></script>
    <script src="https://unpkg.com/@dnd-kit/utilities@3.2.1/dist/index.umd.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        const { DndContext, DragOverlay, closestCenter } = DndKit;
        const { SortableContext, verticalListSortingStrategy, useSortable, useDroppable } = DndKitSortable;
        const { CSS } = DndKitUtilities;

        // API functions
        const api = {
            boards: {
                getAll: () => axios.get('/api/boards'),
                create: (name, description) => axios.post('/api/boards', null, { params: { name, description } }),
                delete: (id) => axios.delete(`/api/boards/${id}`),
                importCSV: (boardId, file) => {
                    const formData = new FormData();
                    formData.append('file', file);
                    return axios.post(`/api/boards/${boardId}/import-csv`, formData);
                },
                exportCSV: (boardId) => axios.get(`/api/boards/${boardId}/export-csv`, { responseType: 'blob' })
            },
            tasks: {
                getByBoard: (boardId) => axios.get(`/api/boards/${boardId}/tasks`),
                create: (boardId, title, description, status = 'todo') => 
                    axios.post(`/api/boards/${boardId}/tasks`, null, { params: { title, description, status } }),
                update: (taskId, updates) => axios.put(`/api/tasks/${taskId}`, null, { params: updates }),
                delete: (taskId) => axios.delete(`/api/tasks/${taskId}`)
            }
        };

        // Task component
        const Task = ({ task, onEdit, onDelete, isDragging = false }) => {
            const { attributes, listeners, setNodeRef, transform, transition } = useSortable({ id: task.id });
            
            const style = {
                transform: CSS.Transform.toString(transform),
                transition,
                opacity: isDragging ? 0.5 : 1,
            };

            return (
                <div ref={setNodeRef} style={style} {...attributes} {...listeners}
                     className="bg-white rounded-lg shadow-sm border p-3 cursor-grab hover:shadow-md transition-shadow">
                    <div className="flex justify-between items-start mb-2">
                        <h3 className="font-medium text-gray-800 text-sm">{task.title}</h3>
                        <div className="flex gap-1">
                            <button onClick={(e) => { e.stopPropagation(); onEdit?.(); }}
                                    className="text-blue-500 hover:text-blue-700 text-xs">‚úèÔ∏è</button>
                            <button onClick={(e) => { e.stopPropagation(); onDelete?.(); }}
                                    className="text-red-500 hover:text-red-700 text-xs">üóëÔ∏è</button>
                        </div>
                    </div>
                    {task.description && <p className="text-gray-600 text-xs">{task.description}</p>}
                    <div className="mt-2 text-xs text-gray-400">
                        {new Date(task.created_at).toLocaleDateString()}
                    </div>
                </div>
            );
        };

        // Column component
        const Column = ({ column, tasks, onEditTask, onDeleteTask }) => {
            const { setNodeRef } = useDroppable({ id: column.id });
            
            const getColumnColor = (columnId) => {
                switch (columnId) {
                    case 'todo': return 'bg-red-100 border-red-200';
                    case 'in_progress': return 'bg-yellow-100 border-yellow-200';
                    case 'done': return 'bg-green-100 border-green-200';
                    default: return 'bg-gray-100 border-gray-200';
                }
            };

            return (
                <div className={`rounded-lg border-2 ${getColumnColor(column.id)} p-4`}>
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-lg font-semibold text-gray-700">{column.title}</h2>
                        <span className="bg-gray-500 text-white text-sm px-2 py-1 rounded-full">{tasks.length}</span>
                    </div>
                    <div ref={setNodeRef} className="min-h-[200px] space-y-2">
                        <SortableContext items={tasks.map(task => task.id)} strategy={verticalListSortingStrategy}>
                            {tasks.map(task => (
                                <Task key={task.id} task={task} 
                                      onEdit={() => onEditTask(task)} 
                                      onDelete={() => onDeleteTask(task.id)} />
                            ))}
                        </SortableContext>
                    </div>
                </div>
            );
        };

        // Task Modal component
        const TaskModal = ({ task, onSave, onClose }) => {
            const [formData, setFormData] = useState({ title: '', description: '', status: 'todo' });

            useEffect(() => {
                if (task) {
                    setFormData({ title: task.title, description: task.description || '', status: task.status });
                }
            }, [task]);

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="bg-white rounded-lg p-6 w-96 max-w-md">
                        <h2 className="text-xl font-semibold mb-4">{task ? 'Edit Task' : 'Create New Task'}</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-2">Title</label>
                                <input type="text" value={formData.title} required
                                       onChange={(e) => setFormData({...formData, title: e.target.value})}
                                       className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" />
                            </div>
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                <textarea value={formData.description} rows="3"
                                          onChange={(e) => setFormData({...formData, description: e.target.value})}
                                          className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" />
                            </div>
                            <div className="mb-6">
                                <label className="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <select value={formData.status}
                                        onChange={(e) => setFormData({...formData, status: e.target.value})}
                                        className="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="todo">To Do</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="done">Done</option>
                                </select>
                            </div>
                            <div className="flex gap-2">
                                <button type="submit" className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                                    {task ? 'Update' : 'Create'}
                                </button>
                                <button type="button" onClick={onClose}
                                        className="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        // Board component
        const Board = ({ board, onBack }) => {
            const [tasks, setTasks] = useState([]);
            const [activeTask, setActiveTask] = useState(null);
            const [showTaskModal, setShowTaskModal] = useState(false);
            const [editingTask, setEditingTask] = useState(null);

            const columns = [
                { id: 'todo', title: 'To Do' },
                { id: 'in_progress', title: 'In Progress' },
                { id: 'done', title: 'Done' }
            ];

            useEffect(() => { fetchTasks(); }, [board.id]);

            const fetchTasks = async () => {
                try {
                    const response = await api.tasks.getByBoard(board.id);
                    setTasks(response.data);
                } catch (error) {
                    console.error('Error fetching tasks:', error);
                }
            };

            const handleDragStart = (event) => {
                const task = tasks.find(t => t.id === parseInt(event.active.id));
                setActiveTask(task);
            };

            const handleDragEnd = async (event) => {
                const { active, over } = event;
                setActiveTask(null);
                if (!over) return;

                const taskId = parseInt(active.id);
                const newStatus = over.id;
                const task = tasks.find(t => t.id === taskId);
                
                if (task && task.status !== newStatus) {
                    try {
                        await api.tasks.update(taskId, { status: newStatus });
                        setTasks(prev => prev.map(t => t.id === taskId ? { ...t, status: newStatus } : t));
                    } catch (error) {
                        console.error('Error updating task:', error);
                    }
                }
            };

            const createTask = async (taskData) => {
                try {
                    const response = await api.tasks.create(board.id, taskData.title, taskData.description, taskData.status || 'todo');
                    setTasks(prev => [...prev, response.data]);
                    setShowTaskModal(false);
                } catch (error) {
                    console.error('Error creating task:', error);
                }
            };

            const updateTask = async (taskData) => {
                try {
                    await api.tasks.update(editingTask.id, taskData);
                    setTasks(prev => prev.map(t => t.id === editingTask.id ? { ...t, ...taskData } : t));
                    setEditingTask(null);
                    setShowTaskModal(false);
                } catch (error) {
                    console.error('Error updating task:', error);
                }
            };

            const deleteTask = async (taskId) => {
                if (window.confirm('Are you sure you want to delete this task?')) {
                    try {
                        await api.tasks.delete(taskId);
                        setTasks(prev => prev.filter(t => t.id !== taskId));
                    } catch (error) {
                        console.error('Error deleting task:', error);
                    }
                }
            };

            const handleImportCSV = async (event) => {
                const file = event.target.files[0];
                if (file) {
                    try {
                        await api.boards.importCSV(board.id, file);
                        fetchTasks();
                        event.target.value = '';
                    } catch (error) {
                        console.error('Error importing CSV:', error);
                        alert('Error importing CSV file');
                    }
                }
            };

            const handleExportCSV = async () => {
                try {
                    const response = await api.boards.exportCSV(board.id);
                    const url = window.URL.createObjectURL(new Blob([response.data]));
                    const link = document.createElement('a');
                    link.href = url;
                    link.setAttribute('download', `${board.name}_tasks.csv`);
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                } catch (error) {
                    console.error('Error exporting CSV:', error);
                }
            };

            const getTasksByStatus = (status) => tasks.filter(task => task.status === status);

            return (
                <div className="min-h-screen bg-gray-100 p-8">
                    <div className="max-w-7xl mx-auto">
                        <div className="flex justify-between items-center mb-8">
                            <div className="flex items-center gap-4">
                                <button onClick={onBack} className="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                                    ‚Üê Back
                                </button>
                                <h1 className="text-3xl font-bold text-gray-800">{board.name}</h1>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => { setEditingTask(null); setShowTaskModal(true); }}
                                        className="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                                    Add Task
                                </button>
                                <label className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 cursor-pointer">
                                    Import CSV
                                    <input type="file" accept=".csv" onChange={handleImportCSV} className="hidden" />
                                </label>
                                <button onClick={handleExportCSV}
                                        className="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                                    Export CSV
                                </button>
                            </div>
                        </div>

                        <DndContext collisionDetection={closestCenter} onDragStart={handleDragStart} onDragEnd={handleDragEnd}>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                {columns.map(column => (
                                    <Column key={column.id} column={column} tasks={getTasksByStatus(column.id)}
                                            onEditTask={(task) => { setEditingTask(task); setShowTaskModal(true); }}
                                            onDeleteTask={deleteTask} />
                                ))}
                            </div>
                            <DragOverlay>
                                {activeTask ? <Task task={activeTask} isDragging /> : null}
                            </DragOverlay>
                        </DndContext>

                        {showTaskModal && (
                            <TaskModal task={editingTask}
                                       onSave={editingTask ? updateTask : createTask}
                                       onClose={() => { setShowTaskModal(false); setEditingTask(null); }} />
                        )}
                    </div>
                </div>
            );
        };

        // BoardList component
        const BoardList = ({ onSelectBoard }) => {
            const [boards, setBoards] = useState([]);
            const [showCreateForm, setShowCreateForm] = useState(false);
            const [newBoard, setNewBoard] = useState({ name: '', description: '' });

            useEffect(() => { fetchBoards(); }, []);

            const fetchBoards = async () => {
                try {
                    const response = await api.boards.getAll();
                    setBoards(response.data);
                } catch (error) {
                    console.error('Error fetching boards:', error);
                }
            };

            const createBoard = async (e) => {
                e.preventDefault();
                try {
                    await api.boards.create(newBoard.name, newBoard.description);
                    setNewBoard({ name: '', description: '' });
                    setShowCreateForm(false);
                    fetchBoards();
                } catch (error) {
                    console.error('Error creating board:', error);
                }
            };

            const deleteBoard = async (boardId) => {
                if (window.confirm('Are you sure you want to delete this board?')) {
                    try {
                        await api.boards.delete(boardId);
                        fetchBoards();
                    } catch (error) {
                        console.error('Error deleting board:', error);
                    }
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 p-8">
                    <div className="max-w-6xl mx-auto">
                        <div className="flex justify-between items-center mb-8">
                            <h1 className="text-3xl font-bold text-gray-800">Kanban Boards</h1>
                            <button onClick={() => setShowCreateForm(true)}
                                    className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                                Create New Board
                            </button>
                        </div>

                        {showCreateForm && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                                <div className="bg-white rounded-lg p-6 w-96">
                                    <h2 className="text-xl font-semibold mb-4">Create New Board</h2>
                                    <form onSubmit={createBoard}>
                                        <input type="text" placeholder="Board name" value={newBoard.name} required
                                               onChange={(e) => setNewBoard({...newBoard, name: e.target.value})}
                                               className="w-full p-2 border rounded mb-4" />
                                        <textarea placeholder="Description (optional)" value={newBoard.description} rows="3"
                                                  onChange={(e) => setNewBoard({...newBoard, description: e.target.value})}
                                                  className="w-full p-2 border rounded mb-4" />
                                        <div className="flex gap-2">
                                            <button type="submit" className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                                Create
                                            </button>
                                            <button type="button" onClick={() => setShowCreateForm(false)}
                                                    className="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">
                                                Cancel
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        )}

                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {boards.map(board => (
                                <div key={board.id}
                                     className="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer">
                                    <div className="flex justify-between items-start mb-4">
                                        <h3 className="text-xl font-semibold text-gray-800" onClick={() => onSelectBoard(board)}>
                                            {board.name}
                                        </h3>
                                        <button onClick={() => deleteBoard(board.id)}
                                                className="text-red-500 hover:text-red-700">√ó</button>
                                    </div>
                                    {board.description && <p className="text-gray-600 mb-4">{board.description}</p>}
                                    <button onClick={() => onSelectBoard(board)}
                                            className="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
                                        Open Board
                                    </button>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // Main App component
        const App = () => {
            const [selectedBoard, setSelectedBoard] = useState(null);

            return (
                <div>
                    {selectedBoard ? (
                        <Board board={selectedBoard} onBack={() => setSelectedBoard(null)} />
                    ) : (
                        <BoardList onSelectBoard={setSelectedBoard} />
                    )}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
